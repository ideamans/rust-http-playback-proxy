name: Windows Tests

on:
  push:
    branches:
      - windows

jobs:
  build:
    name: Build (Windows)
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-index-

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-build-target-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-build-target-

      - name: Lint and format check
        run: |
          cargo fmt --all -- --check
          cargo clippy --all-targets --all-features -- -D warnings

      - name: Build main binary
        run: cargo build --release

      - name: Build E2E binaries
        run: |
          cd e2e/performance
          cargo build --release
          cd ../content
          cargo build --release
          cd ../minimum
          cargo build --release

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries
          path: |
            target/release/http-playback-proxy.exe
            e2e/performance/target/release/performance.exe
            e2e/content/target/release/content.exe
            e2e/minimum/target/release/minimum.exe
          retention-days: 1

  test-windows:
    name: Windows ${{ matrix.test-type }}
    needs: build
    strategy:
      fail-fast: false
      matrix:
        test-type: [unit, e2e-performance, e2e-content, integration, acceptance-go, acceptance-ts]

    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        if: matrix.test-type == 'unit' || matrix.test-type == 'integration'
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Setup Go (for acceptance tests)
        if: matrix.test-type == 'acceptance-go'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Node.js (for acceptance tests)
        if: matrix.test-type == 'acceptance-ts'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download binaries
        if: matrix.test-type != 'unit'
        uses: actions/download-artifact@v4
        with:
          name: windows-binaries

      - name: Cache cargo registry
        if: matrix.test-type == 'unit' || matrix.test-type == 'integration'
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        if: matrix.test-type == 'unit' || matrix.test-type == 'integration'
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-index-

      - name: Cache target directory
        if: matrix.test-type == 'unit'
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-unit-target-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-unit-target-

      - name: Unit tests
        if: matrix.test-type == 'unit'
        run: cargo test

      - name: E2E Performance Test
        if: matrix.test-type == 'e2e-performance'
        working-directory: e2e/performance
        shell: pwsh
        run: |
          # Use downloaded binary
          & ../../e2e/performance/target/release/performance.exe
        timeout-minutes: 5

      - name: E2E Content Test
        if: matrix.test-type == 'e2e-content'
        working-directory: e2e/content
        shell: bash
        run: |
          # Use downloaded binary
          chmod +x ../../e2e/content/target/release/content.exe
          ../../e2e/content/target/release/content.exe
        timeout-minutes: 5

      - name: Integration Test
        if: matrix.test-type == 'integration'
        run: cargo test --test integration_test
        timeout-minutes: 5

      - name: Copy binary to Go acceptance test location
        if: matrix.test-type == 'acceptance-go'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path golang/bin/windows-amd64
          Copy-Item target/release/http-playback-proxy.exe golang/bin/windows-amd64/

      - name: Go Acceptance Test
        if: matrix.test-type == 'acceptance-go'
        working-directory: acceptance/golang
        run: go test -v -timeout 5m
        env:
          HTTP_PLAYBACK_PROXY_CACHE_DIR: ${{ github.workspace }}/golang

      - name: Copy binary to TypeScript acceptance test location
        if: matrix.test-type == 'acceptance-ts'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path typescript/bin/windows-amd64
          Copy-Item target/release/http-playback-proxy.exe typescript/bin/windows-amd64/

      - name: Install TypeScript wrapper dependencies
        if: matrix.test-type == 'acceptance-ts'
        working-directory: typescript
        run: npm install

      - name: Build TypeScript wrapper
        if: matrix.test-type == 'acceptance-ts'
        working-directory: typescript
        run: npm run build

      - name: Install TypeScript test dependencies
        if: matrix.test-type == 'acceptance-ts'
        working-directory: acceptance/typescript
        run: npm install

      - name: TypeScript Acceptance Test
        if: matrix.test-type == 'acceptance-ts'
        working-directory: acceptance/typescript
        run: npm test
        env:
          HTTP_PLAYBACK_PROXY_CACHE_DIR: ${{ github.workspace }}/typescript

  summary:
    name: Windows Test Summary
    needs: [test-windows]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.test-windows.result }}" != "success" ]; then
            echo "❌ Some Windows tests failed"
            echo "Test results: ${{ needs.test-windows.result }}"
            exit 1
          fi

          echo "✅ All Windows tests passed!"
